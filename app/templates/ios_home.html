<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaibes - Home</title>

    <!-- Meta tags para web app -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Ícones para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="static/vibe-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/vibe-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/vibe-icon.png">

    <!-- Manifest do Web App -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Meta tags para Android -->
    <meta name="theme-color" content="#022247">
    <link rel="icon" sizes="192x192" href="/static/vibe-icon.png">
    <link rel="icon" sizes="512x512" href="/static/vibe-icon.png">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X2PT21PM9Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-X2PT21PM9Y');
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3814244836764328" crossorigin="anonymous"></script>

    <style>
        /* Estilos rápidos para responsividade */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            padding-bottom: 60px; /* Espaço para a barra inferior */
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
        }

        .filter-bar {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 15px;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-button {
            font-weight: bold;
            font-size: 14px;
            padding: 10px;
            cursor: pointer;
            color: #888;
            border: none;
            background: none;
        }

        .filter-button.active {
            color: #022247;
        }

        .filter-separator {
            margin: 0 10px;
            color: #888;
        }

        .post {
            background-color: #fff;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .post-info {
            display: flex;
            flex-direction: column;
        }

        .post-info strong {
            font-size: 14px;
        }

        .post-date {
            font-size: 12px;
            color: #888;
        }

        .post-body {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }



        /* Barra inferior atualizada */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #fff;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            height: 60px;
            z-index: 999;
            padding-bottom: 5px;
        }

        .create-post-button {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 20px;
            background-color: #022247;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .create-post-button img {
            width: 100%;
            height: 100%;
        }

        .create-post-button span {
            position: absolute;
            bottom: -25px;
            font-size: 12px;
            color: #333;
        }

        .bottom-bar-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: black;
        }

        .bottom-bar-link img {
            width: 24px;
            height: 24px;
        }

        .bottom-bar-link span {
            font-size: 12px;
            color: #333;
            margin-top: 4px;
        }

        /* Modal atualizado */
        .bottom-bar-modal {
            display: none;
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background-color: #fff;
            transition: bottom 0.3s ease-in-out;
            z-index: 1000;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-bar-modal.active {
            bottom: 0;
        }

        .bottom-bar-modal-content {
            padding: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
        }

        .post-textarea {
            width: 100%;
            height: 120px;
            border: none;
            resize: none;
            font-size: 16px;
            margin-bottom: 20px;
            padding: 10px;
            box-sizing: border-box;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background-color: #f5f5f5;
        }

        .post-submit {
            width: 100%;
            padding: 12px;
            background-color: #022247;
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .post-submit:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Demais estilos permanecem os mesmos */
        .dm-button {
            background-color: #022247;
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
        }

        .modal-button {
            padding: 10px;
            background-color: #022247;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }
        .post {
            transition: transform 0.2s ease;
        }

        .post:hover {
            transform: translateY(-2px);
        }

        .like-button, .comment-button {
            transition: transform 0.2s ease;
        }

        .like-button:hover, .comment-button:hover {
            transform: scale(1.1);
        }

        .loading {
            position: relative;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #022247;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilos para o formulário de seguir/deixar de seguir */
.follow-form {
    display: flex;
    align-items: center;
    margin-left: auto;
}

.follow-button {
    background-color: #022247;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
}

.follow-button.following {
    background-color: transparent;
    color: #0095f6;
    border: 1px solid #022247;
}

.follow-button:hover {
    background-color: #0077b6;
}

.follow-button.following:hover {
    background-color: #f0f0f0;
}
/* Estilo geral do botão de like */
.like-button {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: transparent;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    border-radius: 8px; /* Arredondamento dos cantos */
    font-size: 14px; /* Tamanho da fonte do texto */
    color: #022247; /* Cor do texto */
}

/* Efeito de hover para o botão de like */
.like-button:hover {
    background-color: #f1f1f1; /* Cor de fundo suave ao passar o mouse */
    transform: scale(1.05); /* Leve aumento de tamanho ao passar o mouse */
}

/* Estilo do ícone dentro do botão de like */
.like-button img {
    width: 20px; /* Tamanho do ícone */
    height: 20px; /* Tamanho do ícone */
    margin-right: 8px; /* Espaçamento entre o ícone e o texto */
}

.share-button img {
    width: 20px; /* Tamanho do ícone */
    height: 20px; /* Tamanho do ícone */
    margin-right: 8px; /* Espaçamento entre o ícone e o texto */
}

.share-button {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: transparent;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    border-radius: 8px; /* Arredondamento dos cantos */
    font-size: 14px; /* Tamanho da fonte do texto */
    color: #022247; /* Cor do texto */
}

/* Tamanho do texto */
.like-button span {
    font-size: 14px; /* Tamanho do texto de "Curtir" */
    font-weight: bold;
}

/* Quando o post é curtido, o ícone de like muda */
.like-button.liked {
    color: #3e8e41; /* Cor verde para mostrar que o post foi curtido */
}

/* Exemplo de como o ícone pode mudar ao ser curtido */
.like-button.liked img {
    content: url('/static/like-on-icon.png'); /* Troca o ícone para 'like-on' quando o post é curtido */
}

/* Exemplo de quando o botão de like não está curtiu (padrão) */
.like-button img {
    content: url('/static/like-off-icon.png'); /* Exibe o ícone 'like-off' por padrão */
}


    </style>
</head>

<body>
    <!-- Botão de DM -->
    <div class="dm-commentbutton" onclick="openModal()">
        DM
    </div>

    <!-- Modal de DM -->
    <div id="dmModal" class="modal">
        <div class="modal-content">
            <h2>Direct Messages</h2>
            <p>Em breve você poderá enviar mensagens diretas para outros usuários!</p>
            <button class="modal-button" onclick="closeModal()">Fechar</button>
        </div>
    </div>

    <div class="app-container">
        <!-- Barra de filtros -->
        <div class="filter-bar">
            <button id="for-you" class="filter-button" onclick="setPostFilter('relevance')">Para Você</button>
            <span class="filter-separator">|</span>
            <button id="new" class="filter-button active" onclick="setPostFilter('chronological')">Novo</button>
        </div>

        <!-- Área dos posts -->
        <!-- Container de posts -->
        <div class="posts-container">
            {% if posts %}
                {% for post in posts %}
                    <div class="post">
                        <div class="post-header">
                            <img src="{{ post['user']['profile_picture'] }}" alt="Foto de perfil" class="profile-pic">
                            <div class="post-info">
                                <strong>{{ post['user']['username'] }}</strong>
                                <span class="post-date">{{ post['timestamp'] }}</span>
                            </div>
                            <form id="follow-form-{{ post.user.id }}" action="{{ url_for('users.toggle_follow', username=post.user.username) }}" method="POST" class="follow-form">
                                {% if user.is_following(post['user']['id']) %}
                                <button type="submit" class="follow-button following">Deixar de Seguir</button>
                                {% else %}
                                    <button type="submit" class="follow-button">Seguir</button>
                                {% endif %}
                            </form>
                        </div>
                        <div class="post-body" onclick="redirectToPost({{ post.id }})">
                            {% set content = post.content %}
                            {% for word in content.split() %}
                                {% if word.startswith('#') %}
                                    <a href="/hashtag/{{ word[1:] }}">{{ word }}</a>
                                {% else %}
                                    {{ word }}
                                {% endif %}

                            {% endfor %}
                                {% if post['img_url'] %}
                                    <img src="{{ post['img_url'] }}" alt="Imagem do post" style="width: 100%; margin-top: 10px; border-radius: 8px;">
                                {% endif %}
                        </div>
                        <div class="post-footer">
                            <div class="post-footer">
                                <button class="like-button {% if post.liked %}liked{% endif %}" id="like-button-{{ post.id }}" onclick="likePost({{ post.id }})">
                                    <img src="{{ url_for('static', filename=post.liked and 'like-on-icon.png' or 'like-off-icon.png') }}" id="like-icon-{{ post.id }}" alt="Curtir">
                                    <span id="like-count-{{ post.id }}">{{ post['likes'] }}</span>
                                </button>
                                <button class="share-button" id="share-button-{{ post.id }}" onclick="sharePost({{ post.id }})">
                                    <img src="{{ url_for('static', filename='share-icon.png') }}" id="like-icon-{{ post.id }}" alt="Curtir">
                                </button>
                            </div>                            
                        </div>
                        
                        
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: #888;">Nenhum post encontrado.</p>
            {% endif %}
        </div>
        

    
    </div>

    <!-- Barra de navegação inferior -->
    <div class="bottom-bar">
        <a href="{{ url_for('main.home') }}" class="bottom-bar-link">
            <img src="{{ url_for('static', filename='home-icon.png') }}" alt="Home">
            <span>Home</span>
        </a>
        <a href="{{ url_for('main.search') }}" class="bottom-bar-link">
            <img src="{{ url_for('static', filename='search-icon.png') }}" alt="Buscar">
            <span>Buscar</span>
        </a>
        <div class="create-post-button" onclick="openPostModal()">
            <img src="{{ url_for('static', filename='post-icon.png') }}" alt="Criar">
            <span>Criar</span>
        </div>
        <a href="{{ url_for('notifications.notifications') }}" class="bottom-bar-link">
            <img src="{{ url_for('static', filename='notifications-icon.png') }}" alt="Notificações">
            <span>Notificações</span>
        </a>
        <a href="{{ url_for('users.profile', username=user.username) }}" class="bottom-bar-link">
            <img src="{{ user.profile_picture or url_for('static', filename='uploads/default-profile-pic.png') }}" alt="Foto de perfil" class="profile-pic">
            <span>Perfil</span>
        </a>
    </div>

    <!-- Modal de criação de post atualizado -->
    <div id="bottom-bar-modal" class="bottom-bar-modal">
        <div class="bottom-bar-modal-content">
            <div class="modal-header">
                <h3>Criar post</h3>
                <button class="modal-close" onclick="closePostModal()">×</button>
            </div>
            
            <textarea class="post-textarea" placeholder="O que você está pensando?"></textarea>
            
            <div class="post-actions">
                <button class="action-button">
                    <img src="{{ url_for('static', filename='image-icon.png') }}" alt="Imagem" width="20">
                    Foto
                </button>
                <button class="action-button">
                    <img src="{{ url_for('static', filename='gif-icon.png') }}" alt="GIF" width="20">
                    GIF
                </button>
            </div>
            
            <button class="post-submit">Publicar</button>
        </div>
    </div>

    <script>

function likePost(postId) {
    function likePost(postId) {
    fetch(`/like_post/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        const likeButton = document.getElementById(`like-button-${postId}`);
        const likeCountElement = document.getElementById(`like-count-${postId}`);
        const likeIcon = document.getElementById(`like-icon-${postId}`);

        // Atualiza a contagem de curtidas
        likeCountElement.textContent = data.likes;

        // Alterna o ícone e a classe 'liked' do botão
        if (data.liked) {
            likeButton.classList.add('liked');
            likeIcon.src = '/static/like-on-icon.png';  // Ícone de "like" quando o post é curtido
        } else {
            likeButton.classList.remove('liked');
            likeIcon.src = '/static/like-off-icon.png'; // Ícone de "like" quando o post não é curtido
        }
    })
    .catch(error => {
        console.error('Erro ao curtir o post:', error);
    });
}
}
function setPostFilter(filterType) {
    // Remove a classe 'active' de ambos os botões
    document.getElementById('new').classList.remove('active');
    document.getElementById('for-you').classList.remove('active');

    // Adiciona a classe 'active' ao botão correspondente
    if (filterType === 'relevance') {
        document.getElementById('for-you').classList.add('active');
    } else if (filterType === 'chronological') {
        document.getElementById('new').classList.add('active');
    }

    // Redireciona a página com o filtro aplicado
    window.location.href = `/?filter=${filterType}`;
}


        class PostManager {
            constructor() {
                this.posts = [];
                this.currentFilter = 'new';
                this.initializeSamplePosts();
            }
            
            initializeSamplePosts() {
                this.posts = [
                    {
                        name: "João Silva",
                        time: "2h atrás",
                        content: "Acabei de descobrir uma música incrível! 🎵",
                        likes: 15,
                        comments: 3
                    },
                    {
                        name: "Maria Oliveira",
                        time: "4h atrás",
                        content: "Dia produtivo hoje! 💪",
                        likes: 24,
                        comments: 5
                    }
                ];
                this.renderPosts();
            }
            
            addPost(post) {
                this.posts.unshift(post);
                this.renderPosts();
            }
            
            renderPosts() {
                const container = document.getElementById('posts-container');
                container.innerHTML = '';
                
                this.posts
                    .filter(post => this.filterPost(post))
                    .forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.className = 'post';
                        postElement.innerHTML = `
                            <div class="post-header">
                                <img src="{{ url_for('static', filename='profile-placeholder.png') }}" alt="Profile" class="profile-pic">
                                <div class="post-info">
                                    <strong>${post.name}</strong>
                                    <span class="post-date">${post.time}</span>
                                </div>
                            </div>
                            <div class="post-body">
                                ${post.content}
                            </div>
                            <div class="post-footer">
                                <button class="like-button" onclick="handleLike(this, ${post.likes})">❤️ ${post.likes}</button>
                                <button class="comment-button">💬 ${post.comments}</button>
                            </div>
                        `;
                        container.appendChild(postElement);
                    });
            }
            
            filterPost(post) {
                if (this.currentFilter === 'new') {
                    return true;
                }
                return post.likes > 10; // Lógica para trending
            }

            setFilter(filter) {
                this.currentFilter = filter;
                this.renderPosts();
            }
        }

        // Instância global do gerenciador de posts
        const postManager = new PostManager();

        // Função para definir filtro ativo
        function setActiveFilter(button) {
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // Atualiza o filtro no PostManager
            const filterType = button.textContent.toLowerCase();
            postManager.setFilter(filterType);
        }

        // Funções do modal de DM
        function openModal() {
            document.getElementById('dmModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('dmModal').classList.remove('show');
        }

        // Funções do modal de criação de post
        function openPostModal() {
            const modal = document.getElementById('bottom-bar-modal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function closePostModal() {
            const modal = document.getElementById('bottom-bar-modal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Tratamento de erros
        function handleError(error, context) {
            console.error(`Erro no ${context}:`, error);
            
            const errorMessages = {
                'network': 'Erro de conexão. Verifique sua internet.',
                'auth': 'Você precisa estar logado para realizar esta ação.',
                'default': 'Ocorreu um erro. Tente novamente mais tarde.'
            };
            
            alert(errorMessages[error.type] || errorMessages.default);
        }

        // Função para lidar com likes
        async function handleLike(button, currentLikes) {
            try {
                button.classList.add('loading');
                // Simulando uma chamada de API
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const newLikes = currentLikes + 1;
                button.innerHTML = `❤️ ${newLikes}`;
            } catch (error) {
                handleError(error, 'like do post');
            } finally {
                button.classList.remove('loading');
            }
        }

        // Configuração do textarea e botão de submit
        document.addEventListener('DOMContentLoaded', function() {
            const postTextarea = document.querySelector('.post-textarea');
            const postSubmitButton = document.querySelector('.post-submit');

            postTextarea.addEventListener('input', function() {
                postSubmitButton.disabled = !this.value.trim();
            });

            postSubmitButton.addEventListener('click', async function() {
                if (this.disabled) return;
                
                this.disabled = true;
                try {
                    const newPost = {
                        name: "Usuário",
                        time: "Agora",
                        content: postTextarea.value,
                        likes: 0,
                        comments: 0
                    };
                    
                    postManager.addPost(newPost);
                    closePostModal();
                    postTextarea.value = '';
                } catch (error) {
                    handleError(error, 'criação de post');
                } finally {
                    this.disabled = false;
                }
            });
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Fechar modal quando clicar fora
        window.onclick = function(event) {
            const dmModal = document.getElementById('dmModal');
            if (event.target === dmModal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
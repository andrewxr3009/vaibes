<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Post</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='script.css') }}">
    
    <!-- Scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>

    <!-- Inicialização do Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCx3huLfApzRJPETN8JwINUnVBoM1Krdvc",
            authDomain: "app-vaibes.firebaseapp.com",
            projectId: "app-vaibes",
            storageBucket: "app-vaibes.appspot.com",
            messagingSenderId: "842665045470",
            appId: "1:842665045470:web:edbe6c0cf3db4ac71c014f",
            measurementId: "G-3WTKSP88V9"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
</head>

<body>
    <div class="container">
        <div class="post">
            <div class="profile-info">
                <img src="{{ post.user.profile_picture if post.user.profile_picture else url_for('static', filename='default-profile-pic.png') }}" alt="Foto de perfil" class="profile-picture">
                <h2>{{ post.user.username }}</h2>
            </div>
            <div class="post-content">
                <p>{{ post.content }}</p>
                {% if post.gif_url %}
                    <img src="{{ post.gif_url }}" alt="GIF">
                {% endif %}
                {% if post.img_url %}
                            <div class="photo-container">
                                <img src="{{ post.img_url }}" alt="Foto" class="photo-item">
                            </div>
                        {% endif %}
                <form id="follow-form-{{ post.user.id }}" action="{{ url_for('toggle_follow', username=post.user.username) }}" method="POST">
                    {% if user.is_following(post.user) %}
                        <button type="submit" class="btn btn-danger">Deixar de Seguir</button>
                    {% else %}
                        <button type="submit" class="btn btn-primary">Seguir</button>
                    {% endif %}
                </form>
                <button class="like-button" id="like-button-{{ post.id }}" onclick="likePost({{ post.id }})">
                    Curtir (<span id="like-count-{{ post.id }}">{{ post.likes|length }}</span>)
                </button>
                <button class="share-button" onclick="sharePost({{ post.id }})">Compartilhar</button>
            </div>
            <div class="comments-section">
                <h3>Comentários</h3>
                <form id="comment-form" onsubmit="addComment(event, {{ post.id }})">
                    <textarea id="comment-text" rows="3" placeholder="Adicione um comentário"></textarea>
                    <button type="submit">Comentar</button>
                </form>
                <div id="comments-list">
                    {% for comment in comments %}
                        <div class="comment">
                            <strong>{{ comment.user.username }}</strong>
                            <p>{{ comment.content }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <a href="{{ url_for('home') }}" style="text-align: center; display: block; color: #022247;">Voltar para a Home</a>
    </div>

    <script>
        // Função para curtir o post
        function likePost(postId) {
            fetch(`/like_post/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`like-count-${postId}`).innerText = data.like_count;
                    const likeButton = document.getElementById(`like-button-${postId}`);
                    likeButton.classList.toggle('liked');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('Erro ao curtir o post: ' + error);
            });
        }

        // Função para adicionar um comentário
        function addComment(event, postId) {
            event.preventDefault();
            const commentText = document.getElementById('comment-text').value.trim();

            if (!commentText) {
                alert('O comentário não pode estar vazio!');
                return;
            }

            fetch(`/add_comment/${postId}`, {
                method: 'POST',
                body: JSON.stringify({ content: commentText }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const commentList = document.getElementById('comments-list');
                    const newComment = document.createElement('div');
                    newComment.classList.add('comment');
                    newComment.innerHTML = `<strong>${data.comment.author.username}</strong><p>${data.comment.content}</p>`;
                    commentList.appendChild(newComment);
                    document.getElementById('comment-text').value = '';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('Erro ao adicionar o comentário: ' + error);
            });
        }

        // Função para compartilhar o post
        function sharePost(postId) {
            alert("Post compartilhado! (Lógica de compartilhamento será implementada)");
        }

        // Função para seguir/deixar de seguir
        document.getElementById('follow-form').onsubmit = function(event) {
            event.preventDefault(); // Impede o envio do formulário
            const form = this;
        
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Erro ao seguir/deixar de seguir');
                }
            }).then(data => {
                // Atualize o botão com base na resposta
                const button = form.querySelector('button');
                if (data.following) {
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-danger');
                    button.textContent = 'Deixar de Seguir';
                } else {
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-primary');
                    button.textContent = 'Seguir';
                }
                alert(data.message);
            }).catch(error => {
                alert(error);
            });
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Vaibes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='script.css') }}">

    <!-- Pusher Beams -->
    <script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <script>
        // Inicializa o Pusher
        const pusher = new Pusher('125aed71fd441d77aae7', {
            cluster: 'sa1',
            encrypted: true
        });

        // Inscreve-se no canal específico
        const channel = pusher.subscribe('my-channel');

        // Escuta o evento 'my-event'
        channel.bind('my-event', function(data) {
            alert('Nova notificação: ' + data.message);
            console.log('Notificação recebida:', data);
        });

        // Solicita a ativação de notificações
        const beamsClient = new PusherPushNotifications.Client({
            instanceId: 'f2a1468e-40d9-4beb-a382-52525b38948b'
        });

        async function requestNotifications() {
            try {
                const token = await beamsClient.start();
                console.log("Token de dispositivo encontrado:", token);
                document.getElementById('device-token').value = token;
                await beamsClient.addDeviceInterest('hello');
                console.log('Dispositivo inscrito com sucesso!');
            } catch (err) {
                console.error("Erro ao ativar notificações:", err);
            }
        }

        // Ação ao carregar a página
        window.onload = function() {
            requestNotifications();  // Solicitar notificações ao carregar
            loadMorePosts();  // Carregar os primeiros posts
        };

        let offset = 0;
        const limit = 10;  // Número de posts por vez
        let loading = false;  // Evitar múltiplas requisições ao mesmo tempo

        // Função para carregar mais posts
        function loadMorePosts() {
            if (loading) return;  // Se já está carregando, não fazer outra requisição

            loading = true;
            fetch(`/load_posts?offset=${offset}&limit=${limit}`)
                .then(response => response.json())
                .then(posts => {
                    if (posts.length > 0) {
                        // Incrementar o offset para a próxima requisição
                        offset += posts.length;

                        // Inserir os novos posts na página
                        posts.forEach(post => {
                            const postElement = document.createElement('div');
                            postElement.classList.add('post');
                            postElement.innerHTML = `
                                <p><strong>${post.username}</strong></p>
                                <p>${post.content}</p>
                                <img src="${post.gif_url}" alt="GIF">
                                <p>${new Date(post.created_at).toLocaleString()}</p>
                            `;
                            document.getElementById('post-container').appendChild(postElement);
                        });
                    } else {
                        console.log('Sem mais posts.');
                    }
                    loading = false;
                })
                .catch(err => {
                    console.error('Erro ao carregar posts:', err);
                    loading = false;
                });
        }

        // Função que detecta quando o usuário rola até o final da página
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadMorePosts();
            }

            // Se o usuário rolar até o topo da página, recarregar
            if (window.scrollY === 0) {
                window.location.reload();  // Recarrega a página
            }
        });
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaibes - Home</title>
    
    <!-- Meta tags para web app -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Ícones para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="static/vibe-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/vibe-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/vibe-icon.png">

    <!-- Manifest do Web App -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Meta tags para Android -->
    <meta name="theme-color" content="#022247">
    <link rel="icon" sizes="192x192" href="/static/vibe-icon.png">
    <link rel="icon" sizes="512x512" href="/static/vibe-icon.png">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X2PT21PM9Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-X2PT21PM9Y');
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3814244836764328" crossorigin="anonymous"></script>

    <style>
.body { font-family: Arial, sans-serif; background-color: #bfbfbf; margin: 0; padding: 0; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .posts-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; } /* Alterado de column-reverse para column */
        .post { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 10px; padding: 10px; cursor: pointer; position: relative; }               .profile-pic { border-radius: 50%; width: 36px; height: 36px; margin-right: 8px; }
        .post-info { flex: 1; }
        .post-options { position: absolute; top: 10px; right: 10px; cursor: pointer; }
        .post-options-menu { display: none; position: absolute; top: 30px; right: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 5px; z-index: 999; }
        .post-options-menu.active { display: block; }
        .post-options-menu button { padding: 8px; width: 100%; background: none; border: none; text-align: left; cursor: pointer; }
        .post-body { margin: 8px 0; }
        .post-actions { display: flex; align-items: center; justify-content: space-between; }
        .like-container { display: flex; align-items: center; }
        .like-icon, .action-icon { width: 16px; height: 16px; cursor: pointer; } /* Tamanhos ajustados */
        .bottom-bar { 
        display: flex; 
        justify-content: space-around; 
        align-items: center; 
        background: #fff; 
        padding: 5px 0; 
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1); 
        position: fixed; 
        bottom: 0; 
        width: 100%; 
        height: 50px; /* Definindo uma altura fixa */
        }
        .bottom-bar img {
        width: 24px; /* Tamanho dos ícones ajustado */
        height: 24px;} /* Tamanho dos ícones ajustado */
        .bottom-bar-modal { display: none; position: fixed; z-index: 1; left: 0; bottom: 0; width: 100%; height: 70%; background-color: rgba(0, 0, 0, 0.4); }
        .bottom-bar-modal.active { display: block; }
        .bottom-bar-modal-content { background-color: #fefefe; height: 100%; padding: 20px; display: flex; flex-direction: column; }
        .bottom-bar-modal-content textarea { width: 100%; height: 60px; margin-bottom: 10px; border: 1px solid #ddd; padding: 10px; }
        .bottom-bar-modal-content button { background-color: #022247; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
        .bottom-bar-modal-content button:hover { background-color: #0056b3; }
        .like-button, .share-button {
    background-color: #022247;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    margin-right: 10px;
}

.like-button.liked {
    background-color: #022247;
}
.follow-button {
    background-color: #022247; /* Cor de fundo */
    color: white; /* Cor do texto */
    border: none; /* Sem borda */
    padding: 5px 10px; /* Ajuste do padding para um botão menor */
    border-radius: 15px; /* Bordas arredondadas */
    cursor: pointer; /* Cursor pointer */
    font-size: 0.9em; /* Tamanho da fonte ajustado */
}

.post-header {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Para que a data fique à direita */
}

    </style>
    <script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="posts-container">
            {% if posts %}
                {% for post in posts %}
                <div class="post" id="post-{{ post.id }}">
                    <div class="post-header">
                        <img src="{{ post.user.profile_picture or url_for('static', filename='uploads/default-profile-pic.png') }}" alt="Foto de perfil" class="profile-pic">
                        <div class="post-info" style="flex-grow: 1;">
                            <a href="{{ url_for('profile', username=post.user.username) }}">
                                <strong>{{ post.user.username }}</strong>
                            </a>
                            <form id="follow-form-{{ post.user.id }}" action="{{ url_for('toggle_follow', username=post.user.username) }}" method="POST" style="display: inline;">
                                {% if user.is_following(post.user) %}
                                    <button type="submit" class="follow-button" style="margin-left: 10px;">Deixar de Seguir</button>
                                {% else %}
                                    <button type="submit" class="follow-button" style="margin-left: 10px;">Seguir</button>
                                {% endif %}
                            </form>
                            <span style="float: right;">{{ post.timestamp.strftime('%d de %B de %Y') }}</span>
                        </div>
                        <div class="post-options" onclick="toggleOptions({{ post.id }})">•••</div>
                        <div class="post-options-menu" id="options-menu-{{ post.id }}">
                            {% if session['user_id'] == post.user.id %}
                                <button onclick="deletePost({{ post.id }})">Excluir</button>
                                <button onclick="viewInsights({{ post.id }})">Ver Insights</button>
                            {% else %}
                                <button>Denunciar</button>
                                <button>Silenciar</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="post-body" onclick="redirectToPost({{ post.id }})">
                        {% set content = post.content %}
                        {% for word in content.split() %}
                            {% if word.startswith('#') %}
                                <a href="/hashtag/{{ word[1:] }}">{{ word }}</a>
                            {% else %}
                                {{ word }}
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="post-actions">
                        <div class="like-container">
                            <button class="like-button" id="like-button-{{ post.id }}" onclick="likePost({{ post.id }})">
                                Curtir (<span id="like-count-{{ post.id }}">{{ post.likes|length }}</span>)
                            </button>
                        </div>

                        <img src="{{ url_for('static', filename='send-icon.png') }}" alt="Compartilhar" class="action-icon" onclick="sharePost({{ post.id }})">
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Nenhum post encontrado.</p>
            {% endif %}
        </div>
        
        <script>
            // Função para curtir o post
            function likePost(postId) {
                fetch(`/like_post/${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById(`like-count-${postId}`).innerText = data.like_count;
                        const likeButton = document.getElementById(`like-button-${postId}`);
                        likeButton.classList.toggle('liked');
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    alert('Erro ao curtir o post: ' + error);
                });
            }
        
            // Função para seguir/deixar de seguir
            document.querySelectorAll('form[id^="follow-form-"]').forEach(form => {
                form.onsubmit = function(event) {
                    event.preventDefault(); // Impede o envio do formulário
                    const form = this;
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => response.json()).then(data => {
                        const button = form.querySelector('button');
                        if (data.following) {
                            button.classList.remove('btn-primary');
                            button.classList.add('btn-danger');
                            button.textContent = 'Deixar de Seguir';
                        } else {
                            button.classList.remove('btn-danger');
                            button.classList.add('btn-primary');
                            button.textContent = 'Seguir';
                        }
                        alert(data.message);
                    }).catch(error => {
                        alert('Erro ao seguir/deixar de seguir: ' + error);
                    });
                };
            });
        
            // Função para redirecionar para a página de detalhes do post
            function redirectToPost(postId) {
                window.location.href = `/post/${postId}`;
            }
        
            // Função para compartilhar o post
            function sharePost(postId) {
                alert("Post compartilhado! (Lógica de compartilhamento será implementada)");
            }
        
            // Função para alternar o menu de opções do post
            function toggleOptions(postId) {
                document.getElementById(`options-menu-${postId}`).classList.toggle('active');
            }
        </script>
        
        <div class="bottom-bar">
                <a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='home-icon.png') }}" alt="Home">
                <span>Início</span>
            </a>
            <a href="{{ url_for('notifications') }}">
                <img src="{{ url_for('static', filename='notifications-icon.png') }}" alt="Notificações">
                <span>Notificações</span>
            </a>
            <div class="create-post-button" onclick="openModal()">
                <img src="{{ url_for('static', filename='post-icon.png') }}" alt="Criar Post">
                <span>Criar</span>
            </div>
            <a href="{{ url_for('profile', username=user.username) }}">
                <img src="{{ user.profile_picture or url_for('static', filename='uploads/default-profile-pic.png') }}" alt="Foto de perfil" class="profile-pic">
                <span>Perfil</span>
            </a>
            <a href="{{ url_for('search') }}">
                <img src="{{ url_for('static', filename='search-icon.png') }}" alt="Pesquisar">
                <span>Buscar</span>
                </a>
        </div>
        
        <div id="bottom-bar-modal" class="bottom-bar-modal">
            <div class="bottom-bar-modal-content">
                <button type="button" onclick="closeModal()">Fechar</button>
                <form id="postForm" action="{{ url_for('create_post') }}" method="POST">
                    <textarea name="content" placeholder="O que você está pensando?" required></textarea>
                    <input type="text" id="gif-url" name="gif_url" placeholder="Cole o link do GIF (opcional)">
                    <input type="hidden" id="hashtag-input" name="hashtags">
                    <button type="submit">Postar</button>
                </form>
            </div>
        </div>

        <script>

            function deletePost(postId) {
                if (confirm('Tem certeza que deseja excluir este post?')) {
                    fetch(`/delete_post/${postId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById(`post-${postId}`).remove();
                                alert('Post excluído com sucesso!');
                            } else {
                                alert('Erro ao excluir o post.');
                            }
                        });
                }
            }

            function viewInsights(postId) {
                window.location.href = `/insights/${postId}`;
            }

            function openModal() {
                document.getElementById('bottom-bar-modal').classList.add('active');
                document.getElementById('bottom-bar').classList.add('hidden');
            }

            function closeModal() {
                document.getElementById('bottom-bar-modal').classList.remove('active');
                document.getElementById('bottom-bar').classList.remove('hidden');
                document.getElementById('gif-url').value = '';
                document.getElementById('hashtag-input').value = ''; // Limpar campo de hashtags
            }

            document.getElementById('postForm').addEventListener('submit', function(event) {
                const content = document.querySelector('textarea[name="content"]').value;
                const hashtags = content.match(/#\w+/g) || []; // Captura hashtags ou um array vazio
                document.getElementById('hashtag-input').value = hashtags.join(','); // Armazena hashtags no campo oculto
            });
        </script>
    </div>
</body>
</html>

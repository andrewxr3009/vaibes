<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaibes - Home</title>
    
    <!-- Meta tags para web app -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Ícones para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="static/vibe-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/vibe-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/vibe-icon.png">

    <!-- Manifest do Web App -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Meta tags para Android -->
    <meta name="theme-color" content="#022247">
    <link rel="icon" sizes="192x192" href="/static/vibe-icon.png">
    <link rel="icon" sizes="512x512" href="/static/vibe-icon.png">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X2PT21PM9Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-X2PT21PM9Y');
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3814244836764328" crossorigin="anonymous"></script>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #bfbfbf; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden;
        }
        .app-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
        }
        .posts-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
        }
        .post { 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            margin-bottom: 10px; 
            padding: 10px; 
            cursor: pointer; 
            position: relative; 
        }
        .profile-pic { 
            border-radius: 50%; 
            width: 36px; 
            height: 36px; 
            margin-right: 8px; 
        }
        .filter-bar { 
            display: flex; 
            justify-content: center; 
            background-color: #fff; 
            padding: 10px 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        .filter-button {
            background-color: #022247;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 20px;
            cursor: pointer;
        }
        .filter-button.active {
            background-color: #0056b3;
        }
        .bottom-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #fff;
            padding: 5px 0; 
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            height: 50px; /* Altura fixa */
        }
        .bottom-bar img {
            width: 24px; /* Tamanho dos ícones */
            height: 24px;
        }
        .bottom-bar-modal { 
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0; 
            bottom: 0; 
            width: 100%; 
            height: 70%; 
            background-color: rgba(0, 0, 0, 0.4); 
        }
        .bottom-bar-modal.active { 
            display: block; 
        }
        .bottom-bar-modal-content { 
            background-color: #fefefe; 
            height: 100%; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        .bottom-bar-modal-content textarea { 
            width: 100%; 
            height: 60px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd; 
            padding: 10px; 
        }
        .bottom-bar-modal-content button { 
            background-color: #022247; 
            color: white; 
            border: none; 
            padding: 8px; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .bottom-bar-modal-content button:hover { 
            background-color: #0056b3; 
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Filtro para ordenação dos posts -->
        <div class="filter-bar">
            <button class="filter-button active" id="for-you" onclick="setPostFilter('relevance')">For You</button>
            <button class="filter-button" id="legacy" onclick="setPostFilter('chronological')">Legacy</button>
        </div>

        <div class="posts-container">
            {% if posts %}
                {% for post in posts %}
                <div class="post" id="post-{{ post.id }}">
                    <div class="post-header">
                        <img src="{{ post.user.profile_picture or url_for('static', filename='uploads/default-profile-pic.png') }}" alt="Foto de perfil" class="profile-pic">
                        <div class="post-info">
                            <span class="username">{{ post.user.username }}</span>
                            <button id="follow-btn-{{ post.user.username }}" class="follow-btn" onclick="toggleFollow('{{ post.user.username }}')" 
                            style="background-color: {{ 'transparent' if is_following else '#022247' }}; border-color: #022247;">
                            {{ 'Seguindo' if is_following else 'Seguir' }}
                           </button>
                            <span class="post-date">{{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                    </div>
                    <div class="post-body" onclick="redirectToPost({{ post.id }})">
                        {% set content = post.content %}
                        {% for word in content.split() %}
                            {% if word.startswith('#') %}
                                <a href="/hashtag/{{ word[1:] }}">{{ word }}</a>
                            {% else %}
                                {{ word }}
                            {% endif %}
                        {% endfor %}
                        {% if post.gif_url %}
                            <div class="gif-container">
                                <img src="{{ post.gif_url }}" alt="GIF" class="gif-item">
                            </div>
                        {% endif %}
                    </div>
                    <div class="post-actions">
                        <div class="like-container">
                            <button class="like-button" id="like-button-{{ post.id }}" onclick="likePost({{ post.id }})">
                                Curtir (<span id="like-count-{{ post.id }}">{{ post.likes|length }}</span>)
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Nenhum post encontrado.</p>
            {% endif %}
        </div>

        <div class="bottom-bar">
            <a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='home-icon.png') }}" alt="Home">
                <span>Início</span>
            </a>
            <a href="{{ url_for('notifications') }}">
                <img src="{{ url_for('static', filename='notifications-icon.png') }}" alt="Notificações">
                <span>Notificações</span>
            </a>
            <div class="create-post-button" onclick="openModal()">
                <img src="{{ url_for('static', filename='post-icon.png') }}" alt="Criar Post">
                <span>Criar</span>
            </div>
            <a href="{{ url_for('profile', username=user.username) }}">
                <img src="{{ user.profile_picture or url_for('static', filename='uploads/default-profile-pic.png') }}" alt="Foto de perfil" class="profile-pic">
                <span>Perfil</span>
            </a>
            <a href="{{ url_for('search') }}">
                <img src="{{ url_for('static', filename='search-icon.png') }}" alt="Pesquisar">
                <span>Buscar</span>
            </a>
        </div>

        <div id="bottom-bar-modal" class="bottom-bar-modal">
            <div class="bottom-bar-modal-content">
                <button type="button" onclick="closeModal()">Fechar</button>
                <form id="postForm" action="{{ url_for('create_post') }}" method="POST">
                    <textarea name="content" placeholder="O que você está pensando?" required></textarea>
                    <input type="text" id="gif-search" placeholder="Buscar GIFs" oninput="searchGifs()">
                    <div id="gif-results" class="gif-container"></div>
                    <input type="hidden" id="gif-url" name="gif_url">
                    <button type="submit">Postar</button>
                </form>
            </div>
        </div>

    </div>

    <script>
    function setPostFilter(filterType) {
        // Remove a classe 'active' de ambos os botões
        document.getElementById('for-you').classList.remove('active');
        document.getElementById('legacy').classList.remove('active');
        
        // Adiciona a classe 'active' ao botão correspondente
        if (filter === 'relevance') {
            document.getElementById('for-you').classList.add('active');
        } else if (filter === 'chronological') {
            document.getElementById('legacy').classList.add('active');
        }
        
        // Redireciona a página com o filtro aplicado
        window.location.href = `/?filter=${filter}`;
                }

    function toggleFollow(username) {
            fetch(`/follow_user/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    credentials: 'same-origin'
        }
    })

        function likePost(postId) {
            fetch(`/like_post/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`like-count-${postId}`).innerText = data.like_count;
                    const likeButton = document.getElementById(`like-button-${postId}`);
                    likeButton.classList.toggle('liked');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('Erro ao curtir o post: ' + error);
            });
        }

        function openModal() {
            document.getElementById('bottom-bar-modal').classList.add('active');
            document.getElementById('bottom-bar').classList.add('hidden');
        }

        function closeModal() {
            document.getElementById('bottom-bar-modal').classList.remove('active');
            document.getElementById('bottom-bar').classList.remove('hidden');
            document.getElementById('gif-url').value = '';
        }

        function searchGifs() {
            const query = document.getElementById('gif-search').value;
            const gifResults = document.getElementById('gif-results');
            gifResults.innerHTML = '';

            if (query.length > 0) {
                fetch(`https://api.giphy.com/v1/gifs/search?api_key=URqPC2QH6fsA2xCx7ySJTbholry57xjy&q=${query}&limit=5`)
                    .then(response => response.json())
                    .then(data => {
                        data.data.forEach(gif => {
                            const img = document.createElement('img');
                            img.src = gif.images.fixed_height_small.url;
                            img.classList.add('gif-item');
                            img.onclick = () => selectGif(gif.images.fixed_height_small.url);
                            gifResults.appendChild(img);
                        });
                    })
                    .catch(error => console.error('Erro ao buscar GIFs:', error));
            }
        }

        function selectGif(gifUrl) {
            document.getElementById('gif-url').value = gifUrl;
            closeModal();
        }
    </script>
</body>
</html>
